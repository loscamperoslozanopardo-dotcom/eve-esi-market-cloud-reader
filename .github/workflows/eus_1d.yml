name: EVE Universe Solar Systems 11:07 UTC

on:
  schedule:
    # 11:07 UTC every day
    - cron: "7 11 * * *"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: eus_1d
  cancel-in-progress: false

jobs:
  load:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Restore persisted ESI cache headers / last success timestamp.
      - name: Restore state cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: state/eus_hdrs.json
          key: eus-hdrs-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            eus-hdrs-${{ runner.os }}-

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          project_id: eve-market-sandbox

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade google-cloud-bigquery requests

      - name: Run loader (1 + 3 retries, 10 min apart)
        env:
          BQ_PROJECT_ID: eve-market-sandbox
          BQ_DATASET_ID: eve_market
          BQ_LOCATION: EU
          ESI_DATASOURCE: tranquility
          # Provide a useful User-Agent to comply with ESI best practices.
          # Recommended: create this repo secret.
          ESI_USER_AGENT: ${{ secrets.ESI_USER_AGENT }}
          EUS_WORKERS: "20"
          EUS_QPS: "20"
        run: |
          set -euo pipefail

          attempt=0
          while [ $attempt -le 3 ]; do
            echo "[eus] attempt=$attempt"

            if python src/eus_ld.py; then
              echo "[eus] SUCCESS"
              exit 0
            fi

            if [ $attempt -lt 3 ]; then
              echo "[eus] FAILED (attempt=$attempt). Sleeping 600s before retry..."
              sleep 600
            fi

            attempt=$((attempt+1))
          done

          echo "[eus] FAILED after 3 retries. Will wait for next scheduled run." >&2
          exit 1

      # Save the updated state (only matters on success or 304 no-op runs; the script
      # intentionally avoids persisting new cache headers if the BigQuery load failed).
      - name: Save state cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: state/eus_hdrs.json
          key: eus-hdrs-${{ runner.os }}-${{ github.run_id }}

      # No artifacts on success; only upload minimal debug info if something failed.
      - name: Upload debug state (failure only)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: eus-debug-${{ github.run_id }}
          path: |
            state/eus_hdrs.json
