name: Market Serious (5min v2)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"  # m√≠nimo permitido: 5 min :contentReference[oaicite:6]{index=6}

concurrency:
  group: market-serious-5min-v2
  cancel-in-progress: true  # evita solapes :contentReference[oaicite:7]{index=7}

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build plan (scan page=1 everywhere)
        env:
          ESI_DATASOURCE: tranquility
          USER_AGENT: "eve-esi-market-cloud-reader (scan)"
          STATE_PATH: state/market_state.json
          PLAN_PATH: plan/plan.json
          BOOTSTRAP: "0"
        run: |
          python src/market_scan_plan.py

      - name: Commit minimal state + plan
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add state/market_state.json plan/plan.json
          git commit -m "Update market plan/state" || exit 0
          git push

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: market-plan
          path: |
            plan/plan.json
            state/market_state.json
          retention-days: 2

  workers:
    needs: scan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        batch_index: [0, 1, 2]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: market-plan
          path: .

      - name: Run worker batch
        env:
          ESI_DATASOURCE: tranquility
          USER_AGENT: "eve-esi-market-cloud-reader (worker)"
          PLAN_PATH: plan/plan.json
          STATE_PATH: state/market_state.json
          OUT_DIR: out
          BATCH_WORKERS: "3"
          BATCH_INDEX: ${{ matrix.batch_index }}
          MAX_REGIONS_THIS_RUN: "9999"
        run: |
          python src/market_worker_batch.py

      - name: Upload worker output
        uses: actions/upload-artifact@v4
        with:
          name: market-worker-${{ matrix.batch_index }}
          path: out/
          retention-days: 2
